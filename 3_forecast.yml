target_default: 3_forecast

include:
  - 2_munge.yml

packages:
  - survival
  - rloadest

sources:
  - 3_forecast/src/subset_inputs.R
  - 3_forecast/src/apply_rloadest.R

targets:

  3_forecast:
    depends:
      - 3_forecast/out/inputs.rds.ind

  # Targets declared identically 1_data.yml
  1_data/out/sites_subset.yml:
    command: gd_get('1_data/out/sites_subset.yml.ind', config_file='lib/cfg/gd_config.yml')
  1_data/out/comids.tsv:
    command: gd_get('1_data/out/comids.tsv.ind', config_file='lib/cfg/gd_config.yml')

  # Example input preparation an dmodeling
  3_forecast/out/inputs.rds.ind:
    command: subset_inputs(
      ind_file=target_name)
  3_forecast/out/inputs.rds:
    command: c('3_forecast/out/inputs.rds.ind')

  3_forecast/out/forecast.rds.ind:
    command: apply_rloadest(
      output_ind=target_name,
      input_ind='3_forecast/out/inputs.rds.ind')

  # create and execute a task plan for running many combinations of input data,
  # water forecast models, and time windows
  forecast_list:
    command: list_tasks()
  forecast_plan:
    command: plan_forecasts(partitions=wqp_pull_partitions, folders=wqp_pull_folders)
  3_forecast_tasks.yml:
    command: create_forecast_makefile(makefile=target_name, task_plan=wqp_pull_plan)

  # run the data pulls
  3_forecast/log/3_forecast_tasks.ind:
    command: loop_tasks(
      task_plan=forecast_plan, task_makefile='3_forecast_tasks.yml',
      num_tries=I(30), sleep_on_error=I(0))

